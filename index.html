<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Android - Tracking en Tiempo Real</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 24px 0;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.025em;
        }
        
        .header p {
            margin: 8px 0 0 0;
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 400;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            height: 100%;
        }
        
        .info-section {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .device-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 100px;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #545b62, #3d4142);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            font-weight: 600;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, #c69500);
            color: #000;
        }
        
        .precision-control {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-top: 10px;
        }
        
        .precision-control label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .precision-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            margin: 8px 0;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .precision-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .precision-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        .precision-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .precision-control span {
            display: inline-block;
            font-size: 12px;
            font-weight: 600;
            color: #007bff;
            background: #e7f3ff;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
        }
        
        .device-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .device-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .device-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .device-item.active {
            background: #e7f3ff;
            border-left-color: #007bff;
        }
        
        .device-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .device-status {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .device-toggle {
            width: 40px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .device-toggle.active {
            background: #007bff;
        }
        
        .device-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        
        .device-toggle.active::after {
            transform: translateX(20px);
        }
        
        .status-bar {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 5px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: #10b981;
        }
        
        .status-disconnected {
            background-color: #ef4444;
        }
        
        .status-waiting {
            background-color: #f59e0b;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 24px;
        }
        
        .info-panel h3 {
            margin: 0 0 16px 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }
        
        .info-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
            word-break: break-all;
        }
        
        .footer {
            text-align: center;
            margin-top: 32px;
            padding: 24px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .developer-info {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 20px 0;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.875rem;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .status-item {
                margin: 0;
            }
            
            #map {
                height: 400px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GPS Android</h1>
        <p>Seguimiento de ubicaci√≥n en tiempo real</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div id="connectionStatus" class="status-indicator status-waiting"></div>
            <span id="connectionText">Conectando...</span>
        </div>
        <div class="status-item">
            <strong>Dispositivos activos:</strong>
            <span id="activeDevices">0</span>
        </div>
        <div class="status-item">
            <strong>√öltima actualizaci√≥n:</strong>
            <span id="lastUpdate">Esperando datos...</span>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="panel">
                <h3>üîç Vista Familiar</h3>
                <div class="device-controls">
                    <button id="toggleAll" class="btn btn-primary">Mostrar Todos</button>
                    <button id="centerAll" class="btn btn-secondary">Centrar Vista</button>
                    <button id="toggleTrails" class="btn btn-warning" onclick="toggleTodosRecorridos()">Mostrar Recorridos</button>
                    <div class="precision-control">
                        <label for="precisionThreshold">üéØ Umbral de Precisi√≥n:</label>
                        <input type="range" id="precisionThreshold" min="10" max="200" value="100" step="10">
                        <span id="precisionValue">100m</span>
                    </div>
                </div>
                <div id="deviceList" class="device-list">
                    <!-- Lista de dispositivos se generar√° din√°micamente -->
                </div>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <div class="info-section">
        <div class="info-panel">
            <h3>Informaci√≥n de Ubicaci√≥n</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Latitud</div>
                    <div class="info-value" id="latitud">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Longitud</div>
                    <div class="info-value" id="longitud">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Precisi√≥n</div>
                    <div class="info-value" id="precision">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">√öltima actualizaci√≥n</div>
                    <div class="info-value" id="timestamp">--</div>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUpdates">0</div>
                <div class="stat-label">Actualizaciones recibidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgAccuracy">--</div>
                <div class="stat-label">Precisi√≥n promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sessionTime">00:00</div>
                <div class="stat-label">Tiempo de sesi√≥n</div>
            </div>
        </div>
        
        <div class="footer">
            <div class="developer-info">
                <strong>Desarrollado por:</strong> Edmil Jampier Saire Bustamante<br>
                <strong>C√≥digo:</strong> 174449
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script>
        // Variables globales
        let map;
        let ws;
        let reconnectInterval;
        let sessionStartTime = new Date();
        let totalUpdates = 0;
        let accuracySum = 0;
        let sessionTimer;
        let dispositivos = new Map(); // Almacena informaci√≥n de dispositivos
        let marcadores = new Map(); // Almacena marcadores por deviceId
        let circulos = new Map(); // Almacena c√≠rculos de precisi√≥n por deviceId
        let recorridos = new Map(); // Mapa de polylines de recorrido
        let historialUbicaciones = new Map(); // Historial de ubicaciones por dispositivo
        let dispositivosVisibles = new Set(); // Dispositivos actualmente visibles
        let recorridosVisibles = new Set(); // Set de recorridos visibles
        let coloresDispositivos = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'];
        let contadorColores = 0;
        
        // Inicializar el mapa
        function initMap() {
            // Crear mapa centrado en Cusco, Per√∫ (coordenadas por defecto)
            map = L.map('map').setView([-13.53195, -71.967463], 13);
            
            // Agregar capa de mapa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Forzar el redimensionamiento del mapa despu√©s de un breve delay
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            console.log('Mapa inicializado');
        }
        
        // Funci√≥n para obtener o crear dispositivo
        function obtenerDispositivo(deviceId, deviceName) {
            if (!dispositivos.has(deviceId)) {
                const color = coloresDispositivos[contadorColores % coloresDispositivos.length];
                contadorColores++;
                
                const dispositivo = {
                    id: deviceId,
                    nombre: deviceName || `Dispositivo ${deviceId}`,
                    color: color,
                    activo: true,
                    ultimaUbicacion: null
                };
                
                dispositivos.set(deviceId, dispositivo);
                dispositivosVisibles.add(deviceId);
                actualizarListaDispositivos();
            }
            
            return dispositivos.get(deviceId);
        }
        
        // Funci√≥n para crear marcador de dispositivo
        function crearMarcadorDispositivo(dispositivo, ubicacion) {
            const lat = parseFloat(ubicacion.lat);
            const lon = parseFloat(ubicacion.lon);
            const accuracy = parseFloat(ubicacion.accuracy) || 0;
            
            if (isNaN(lat) || isNaN(lon)) {
                console.error('Coordenadas inv√°lidas:', ubicacion);
                return;
            }
            
            const position = [lat, lon];
            const deviceId = dispositivo.id;
            
            // Crear marcador con color espec√≠fico del dispositivo
            const marker = L.marker(position, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${dispositivo.color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                })
            });
            
            // Crear c√≠rculo de precisi√≥n solo si la precisi√≥n es <= 10 metros
            let circle = null;
            if (accuracy <= 10) {
                circle = L.circle(position, {
                    radius: Math.max(accuracy * 0.5, 3), // Radio m√≠nimo de 3m, m√°ximo seg√∫n precisi√≥n
                    color: dispositivo.color,
                    fillColor: dispositivo.color,
                    fillOpacity: 0.08,
                    weight: 1.5,
                    dashArray: '3, 3' // L√≠nea punteada para mejor visualizaci√≥n
                });
            }
            
            // Determinar calidad de se√±al basada en precisi√≥n
            let calidadSenal = 'Excelente';
            let colorCalidad = '#4CAF50'; // Verde
            let iconoCalidad = 'üì∂';
            
            if (accuracy > 50) {
                calidadSenal = 'Pobre';
                colorCalidad = '#F44336'; // Rojo
                iconoCalidad = 'üìµ';
            } else if (accuracy > 20) {
                calidadSenal = 'Regular';
                colorCalidad = '#FF9800'; // Naranja
                iconoCalidad = 'üì∂';
            } else if (accuracy > 10) {
                calidadSenal = 'Buena';
                colorCalidad = '#2196F3'; // Azul
                iconoCalidad = 'üì∂';
            }
            
            // Contenido del popup con informaci√≥n mejorada
            const popupContent = `
                <div style="text-align: center; min-width: 200px;">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                        <div style="width: 12px; height: 12px; background: ${dispositivo.color}; border-radius: 50%; margin-right: 8px;"></div>
                        <strong>${dispositivo.nombre}</strong>
                    </div>
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <small><strong>üìç Coordenadas:</strong></small><br>
                        <small>Lat: ${lat.toFixed(6)}</small><br>
                        <small>Lon: ${lon.toFixed(6)}</small>
                    </div>
                    <div style="background: ${colorCalidad}20; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${colorCalidad};">
                        <small><strong>${iconoCalidad} Precisi√≥n:</strong> ¬±${accuracy.toFixed(1)}m</small><br>
                        <small><strong>Calidad:</strong> <span style="color: ${colorCalidad}; font-weight: bold;">${calidadSenal}</span></small>
                    </div>
                    <small><strong>üïí Actualizado:</strong> ${new Date(ubicacion.timestamp).toLocaleString()}</small>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            // Agregar al historial y actualizar recorrido
            agregarUbicacionHistorial(deviceId, ubicacion);
            
            // Guardar referencias
            marcadores.set(deviceId, marker);
            if (circle) {
                circulos.set(deviceId, circle);
            }
            
            // A√±adir al mapa si el dispositivo est√° visible
            if (dispositivosVisibles.has(deviceId)) {
                marker.addTo(map);
                if (circle) {
                    circle.addTo(map);
                }
            }
            
            return { marker, circle };
        }
        
        // Funci√≥n para agregar ubicaci√≥n al historial y actualizar recorrido
        function agregarUbicacionHistorial(deviceId, ubicacion) {
            if (!historialUbicaciones.has(deviceId)) {
                historialUbicaciones.set(deviceId, []);
            }
            
            const historial = historialUbicaciones.get(deviceId);
            const lat = parseFloat(ubicacion.lat);
            const lon = parseFloat(ubicacion.lon);
            
            // Agregar nueva ubicaci√≥n al historial
            historial.push([lat, lon]);
            
            // Mantener solo las √∫ltimas 100 ubicaciones para evitar sobrecarga
            if (historial.length > 100) {
                historial.shift();
            }
            
            // Actualizar polyline de recorrido
            actualizarRecorrido(deviceId);
        }
        
        // Funci√≥n para crear o actualizar polyline de recorrido
        function actualizarRecorrido(deviceId) {
            const historial = historialUbicaciones.get(deviceId);
            const dispositivo = dispositivos.get(deviceId);
            
            if (!historial || historial.length < 2 || !dispositivo) {
                return;
            }
            
            // Remover polyline existente si existe
            const recorridoExistente = recorridos.get(deviceId);
            if (recorridoExistente) {
                map.removeLayer(recorridoExistente);
            }
            
            // Crear nueva polyline
            const polyline = L.polyline(historial, {
                color: dispositivo.color,
                weight: 3,
                opacity: 0.7,
                smoothFactor: 1
            });
            
            // Guardar referencia
            recorridos.set(deviceId, polyline);
            
            // Agregar al mapa si el recorrido est√° visible
            if (recorridosVisibles.has(deviceId)) {
                polyline.addTo(map);
            }
        }
        
        // Funci√≥n para actualizar marcador existente
        function actualizarMarcadorDispositivo(dispositivo, ubicacion) {
            const deviceId = dispositivo.id;
            const marker = marcadores.get(deviceId);
            const circle = circulos.get(deviceId);
            
            if (!marker || !circle) {
                return crearMarcadorDispositivo(dispositivo, ubicacion);
            }
            
            const lat = parseFloat(ubicacion.lat);
            const lon = parseFloat(ubicacion.lon);
            const accuracy = parseFloat(ubicacion.accuracy) || 0;
            const position = [lat, lon];
            
            // Agregar al historial y actualizar recorrido
            agregarUbicacionHistorial(deviceId, ubicacion);
            
            // Actualizar posiciones
            marker.setLatLng(position);
            circle.setLatLng(position);
            circle.setRadius(Math.min(accuracy * 0.3, 15)); // Aplicar la misma reducci√≥n de tama√±o
            
            // Determinar calidad de se√±al basada en precisi√≥n
            let calidadSenal = 'Excelente';
            let colorCalidad = '#4CAF50'; // Verde
            let iconoCalidad = 'üì∂';
            
            if (accuracy > 50) {
                calidadSenal = 'Pobre';
                colorCalidad = '#F44336'; // Rojo
                iconoCalidad = 'üìµ';
            } else if (accuracy > 20) {
                calidadSenal = 'Regular';
                colorCalidad = '#FF9800'; // Naranja
                iconoCalidad = 'üì∂';
            } else if (accuracy > 10) {
                calidadSenal = 'Buena';
                colorCalidad = '#2196F3'; // Azul
                iconoCalidad = 'üì∂';
            }
            
            // Actualizar popup con informaci√≥n mejorada
            const popupContent = `
                <div style="text-align: center; min-width: 200px;">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                        <div style="width: 12px; height: 12px; background: ${dispositivo.color}; border-radius: 50%; margin-right: 8px;"></div>
                        <strong>${dispositivo.nombre}</strong>
                    </div>
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <small><strong>üìç Coordenadas:</strong></small><br>
                        <small>Lat: ${lat.toFixed(6)}</small><br>
                        <small>Lon: ${lon.toFixed(6)}</small>
                    </div>
                    <div style="background: ${colorCalidad}20; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${colorCalidad};">
                        <small><strong>${iconoCalidad} Precisi√≥n:</strong> ¬±${accuracy.toFixed(1)}m</small><br>
                        <small><strong>Calidad:</strong> <span style="color: ${colorCalidad}; font-weight: bold;">${calidadSenal}</span></small>
                    </div>
                    <small><strong>üïí Actualizado:</strong> ${new Date(ubicacion.timestamp).toLocaleString()}</small>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            return { marker, circle };
        }
        
        // Actualizar informaci√≥n en pantalla
        function updateLocationInfo(data) {
            document.getElementById('latitud').textContent = data.lat.toFixed(6);
            document.getElementById('longitud').textContent = data.lon.toFixed(6);
            document.getElementById('precision').textContent = data.accuracy ? `${data.accuracy.toFixed(1)}m` : 'N/A';
            document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString('es-ES');
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-ES');
            
            // Actualizar estad√≠sticas
            updateStats(data.accuracy);
        }
        
        // Actualizar estad√≠sticas
        function updateStats(accuracy) {
            totalUpdates++;
            document.getElementById('totalUpdates').textContent = totalUpdates;
            
            if (accuracy && accuracy > 0) {
                accuracySum += accuracy;
                const avgAccuracy = accuracySum / totalUpdates;
                document.getElementById('avgAccuracy').textContent = `${avgAccuracy.toFixed(1)}m`;
            }
        }
        
        // Actualizar tiempo de sesi√≥n
        function updateSessionTime() {
            const now = new Date();
            const elapsed = Math.floor((now - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Conectar WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket conectado');
                    updateConnectionStatus('connected', 'Conectado');
                    
                    // Limpiar intervalo de reconexi√≥n
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('Mensaje WebSocket recibido:', message);
                        
                        // Manejar diferentes tipos de mensajes
                        if (message.tipo === 'ubicacion_dispositivo') {
                            // Nueva ubicaci√≥n de un dispositivo espec√≠fico
                            const { deviceId, ubicacion, dispositivo: infoDispositivo } = message.datos;
                            
                            // Verificar que infoDispositivo existe
                            if (!infoDispositivo) {
                                console.warn('Informaci√≥n del dispositivo no disponible en el mensaje');
                                return;
                            }
                            
                            // Obtener o crear dispositivo
                            const dispositivo = obtenerDispositivo(deviceId, infoDispositivo.nombre);
                            dispositivo.color = infoDispositivo.color;
                            
                            // Actualizar √∫ltima ubicaci√≥n del dispositivo
                            dispositivo.ultimaUbicacion = ubicacion;
                            
                            // Actualizar o crear marcador
                            actualizarMarcadorDispositivo(dispositivo, ubicacion);
                            
                            // Actualizar informaci√≥n en pantalla (del √∫ltimo dispositivo activo)
                            updateLocationInfo(ubicacion);
                            
                            // Actualizar lista de dispositivos
                            actualizarListaDispositivos();
                            
                        } else if (message.tipo === 'nuevo_dispositivo') {
                            // Nuevo dispositivo registrado
                            const dispositivo = obtenerDispositivo(message.deviceId, message.nombre);
                            dispositivo.color = message.color;
                            actualizarListaDispositivos();
                            
                        } else if (message.tipo === 'dispositivos') {
                            // Lista completa de dispositivos
                            message.datos.forEach(dispositivoData => {
                                const dispositivo = obtenerDispositivo(dispositivoData.id, dispositivoData.nombre);
                                dispositivo.color = dispositivoData.color;
                                dispositivo.activo = dispositivoData.activo;
                                if (dispositivoData.ultimaUbicacion) {
                                    dispositivo.ultimaUbicacion = dispositivoData.ultimaUbicacion;
                                    actualizarMarcadorDispositivo(dispositivo, dispositivoData.ultimaUbicacion);
                                }
                            });
                            actualizarListaDispositivos();
                            
                        } else if (message.tipo === 'ubicacion' && message.datos) {
                            // Formato legacy - ubicaci√≥n simple
                            const data = message.datos;
                            const deviceId = data.deviceId || 'default';
                            const deviceName = data.deviceName || `Dispositivo ${deviceId}`;
                            const dispositivo = obtenerDispositivo(deviceId, deviceName);
                            
                            dispositivo.ultimaUbicacion = data;
                            actualizarMarcadorDispositivo(dispositivo, data);
                            updateLocationInfo(data);
                            actualizarListaDispositivos();
                        } else if (message.tipo === 'precision_threshold_updated') {
                            // Sincronizaci√≥n de umbral de precisi√≥n
                            if (message.datos && message.datos.threshold) {
                                umbralPrecision = message.datos.threshold;
                                const slider = document.getElementById('precisionThreshold');
                                const valueDisplay = document.getElementById('precisionValue');
                                
                                if (slider && valueDisplay) {
                                    slider.value = umbralPrecision;
                                    valueDisplay.textContent = umbralPrecision + 'm';
                                }
                                
                                // Actualizar visualizaci√≥n con nuevo umbral
                                actualizarVisualizacionPorPrecision();
                                console.log('Umbral de precisi√≥n sincronizado:', umbralPrecision + 'm');
                            }
                        }
                        
                    } catch (error) {
                        console.error('Error al procesar mensaje WebSocket:', error);
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocket desconectado');
                    updateConnectionStatus('disconnected', 'Desconectado');
                    
                    // Intentar reconectar cada 5 segundos
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            console.log('Intentando reconectar...');
                            connectWebSocket();
                        }, 5000);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('Error en WebSocket:', error);
                    updateConnectionStatus('disconnected', 'Error de conexi√≥n');
                };
                
            } catch (error) {
                console.error('Error al crear WebSocket:', error);
                updateConnectionStatus('disconnected', 'Error de conexi√≥n');
            }
        }
        
        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }
        
        // Funci√≥n para cargar dispositivos y ubicaciones existentes
        async function cargarDatosIniciales() {
            try {
                // Cargar lista de dispositivos
                const responseDispositivos = await fetch('/api/dispositivos');
                if (responseDispositivos.ok) {
                    const dataDispositivos = await responseDispositivos.json();
                    
                    dataDispositivos.dispositivos.forEach(dispositivoData => {
                        const dispositivo = obtenerDispositivo(dispositivoData.id, dispositivoData.nombre);
                        dispositivo.color = dispositivoData.color;
                        dispositivo.activo = dispositivoData.activo;
                        
                        if (dispositivoData.ultimaUbicacion) {
                            dispositivo.ultimaUbicacion = dispositivoData.ultimaUbicacion;
                            actualizarMarcadorDispositivo(dispositivo, dispositivoData.ultimaUbicacion);
                        }
                    });
                    
                    actualizarListaDispositivos();
                    console.log('Dispositivos cargados:', dataDispositivos.dispositivos.length);
                }
                
                // Cargar ubicaciones activas como fallback
                const responseUbicaciones = await fetch('/api/ubicaciones');
                if (responseUbicaciones.ok) {
                    const dataUbicaciones = await responseUbicaciones.json();
                    
                    if (dataUbicaciones.ubicaciones.length > 0) {
                        // Centrar mapa en las ubicaciones existentes
                        centrarEnTodos();
                        console.log('Ubicaciones activas cargadas:', dataUbicaciones.ubicaciones.length);
                    }
                }
                
                // Cargar √∫ltima ubicaci√≥n como fallback para compatibilidad
                const responseUltima = await fetch('/api/ubicacion/ultima');
                if (responseUltima.ok) {
                    const dataUltima = await responseUltima.json();
                    if (dataUltima.lat && dataUltima.lon) {
                        const deviceId = dataUltima.deviceId || 'default';
                        const dispositivo = obtenerDispositivo(deviceId, `Dispositivo ${deviceId}`);
                        
                        if (!dispositivo.ultimaUbicacion) {
                            dispositivo.ultimaUbicacion = dataUltima;
                            actualizarMarcadorDispositivo(dispositivo, dataUltima);
                            updateLocationInfo(dataUltima);
                            actualizarListaDispositivos();
                        }
                        
                        console.log('√öltima ubicaci√≥n cargada:', dataUltima);
                    }
                } else {
                    console.log('No hay ubicaciones previas disponibles');
                }
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }
        
        // Funci√≥n para actualizar la lista de dispositivos en la interfaz
        function actualizarListaDispositivos() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            if (dispositivos.size === 0) {
                deviceList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay dispositivos conectados</div>';
                return;
            }
            
            dispositivos.forEach((dispositivo) => {
                const deviceItem = document.createElement('div');
                
                // Determinar precisi√≥n y calidad de se√±al
                let accuracy = 999;
                let signalQuality = 'Sin datos';
                let iconoCalidadDispositivo = '‚ùì';
                let colorCalidadDispositivo = '#999';
                
                if (dispositivo.ultimaUbicacion && dispositivo.ultimaUbicacion.accuracy !== undefined) {
                    accuracy = parseFloat(dispositivo.ultimaUbicacion.accuracy);
                    
                    if (accuracy <= 10) {
                        signalQuality = 'Excelente';
                        iconoCalidadDispositivo = 'üü¢';
                        colorCalidadDispositivo = '#28a745';
                    } else if (accuracy <= 30) {
                        signalQuality = 'Buena';
                        iconoCalidadDispositivo = 'üü°';
                        colorCalidadDispositivo = '#ffc107';
                    } else if (accuracy <= 100) {
                        signalQuality = 'Regular';
                        iconoCalidadDispositivo = 'üü†';
                        colorCalidadDispositivo = '#fd7e14';
                    } else {
                        signalQuality = 'Pobre';
                        iconoCalidadDispositivo = 'üî¥';
                        colorCalidadDispositivo = '#dc3545';
                    }
                }
                
                // Determinar si cumple el umbral de precisi√≥n
                const cumpleUmbral = accuracy <= umbralPrecision;
                const opacity = cumpleUmbral ? 1.0 : 0.5;
                
                deviceItem.className = `device-item ${dispositivo.activo ? 'active' : ''}`;
                deviceItem.style.borderLeftColor = dispositivo.color;
                deviceItem.style.opacity = opacity;
                if (!cumpleUmbral) {
                    deviceItem.style.border = '1px dashed #ccc';
                }
                
                const ultimaActividad = dispositivo.ultimaUbicacion ? 
                    new Date(dispositivo.ultimaUbicacion.timestamp).toLocaleTimeString() : 
                    'Sin datos';
                
                deviceItem.innerHTML = `
                    <div class="device-color" style="background: ${dispositivo.color};"></div>
                    <div class="device-info">
                        <div class="device-name">${dispositivo.nombre} <span style="color: ${colorCalidadDispositivo};">${iconoCalidadDispositivo}</span></div>
                        <div class="device-status">√öltima actividad: ${ultimaActividad}</div>
                        <div class="device-status" style="color: ${colorCalidadDispositivo}; font-size: 11px;">
                            ${signalQuality} (¬±${accuracy.toFixed(0)}m)
                            ${!cumpleUmbral ? ' ‚ö†Ô∏è Precisi√≥n insuficiente' : ''}
                        </div>
                    </div>
                    <div class="device-toggle ${dispositivosVisibles.has(dispositivo.id) ? 'active' : ''}" 
                         onclick="toggleDispositivo('${dispositivo.id}')"></div>
                `;
                
                // Hacer clic en el dispositivo para centrarlo en el mapa
                deviceItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('device-toggle')) {
                        centrarEnDispositivo(dispositivo.id);
                    }
                });
                
                deviceList.appendChild(deviceItem);
            });
            
            // Actualizar contador de dispositivos activos
            const dispositivosActivos = Array.from(dispositivos.values()).filter(d => d.activo && d.ultimaUbicacion).length;
            document.getElementById('activeDevices').textContent = dispositivosActivos;
        }
        
        // Funci√≥n para alternar visibilidad de un dispositivo
        function toggleDispositivo(deviceId) {
            const marker = marcadores.get(deviceId);
            const circle = circulos.get(deviceId);
            const recorrido = recorridos.get(deviceId);
            
            if (dispositivosVisibles.has(deviceId)) {
                // Ocultar dispositivo
                dispositivosVisibles.delete(deviceId);
                if (marker) map.removeLayer(marker);
                if (circle) map.removeLayer(circle);
                // Tambi√©n ocultar recorrido si est√° visible
                if (recorrido && recorridosVisibles.has(deviceId)) {
                    map.removeLayer(recorrido);
                }
            } else {
                // Mostrar dispositivo
                dispositivosVisibles.add(deviceId);
                if (marker) marker.addTo(map);
                if (circle) circle.addTo(map);
                // Mostrar recorrido si los recorridos est√°n habilitados
                if (recorrido && recorridosVisibles.has(deviceId)) {
                    recorrido.addTo(map);
                }
            }
            
            actualizarListaDispositivos();
        }
        
        // Funci√≥n para mostrar/ocultar todos los recorridos
        function toggleTodosRecorridos() {
            const button = document.getElementById('toggleTrails');
            const todosRecorridosVisibles = recorridosVisibles.size === dispositivos.size;
            
            if (todosRecorridosVisibles) {
                // Ocultar todos los recorridos
                recorridosVisibles.clear();
                recorridos.forEach(recorrido => map.removeLayer(recorrido));
                button.textContent = 'Mostrar Recorridos';
            } else {
                // Mostrar todos los recorridos
                dispositivos.forEach((dispositivo, deviceId) => {
                    recorridosVisibles.add(deviceId);
                    const recorrido = recorridos.get(deviceId);
                    if (recorrido && dispositivosVisibles.has(deviceId)) {
                        recorrido.addTo(map);
                    }
                });
                button.textContent = 'Ocultar Recorridos';
            }
        }
        
        // Funci√≥n para centrar el mapa en un dispositivo espec√≠fico
        function centrarEnDispositivo(deviceId) {
            const dispositivo = dispositivos.get(deviceId);
            if (dispositivo && dispositivo.ultimaUbicacion) {
                const lat = parseFloat(dispositivo.ultimaUbicacion.lat);
                const lon = parseFloat(dispositivo.ultimaUbicacion.lon);
                map.setView([lat, lon], 16);
                
                // Abrir popup del marcador
                const marker = marcadores.get(deviceId);
                if (marker) {
                    marker.openPopup();
                }
            }
        }
        
        // Funci√≥n para mostrar/ocultar todos los dispositivos
        function toggleTodosDispositivos() {
            const button = document.getElementById('toggleAll');
            const todosVisibles = dispositivosVisibles.size === dispositivos.size;
            
            if (todosVisibles) {
                // Ocultar todos
                dispositivosVisibles.clear();
                marcadores.forEach(marker => map.removeLayer(marker));
                circulos.forEach(circle => map.removeLayer(circle));
                button.textContent = 'Mostrar Todos';
            } else {
                // Mostrar todos
                dispositivos.forEach((dispositivo, deviceId) => {
                    dispositivosVisibles.add(deviceId);
                    const marker = marcadores.get(deviceId);
                    const circle = circulos.get(deviceId);
                    if (marker) marker.addTo(map);
                    if (circle) circle.addTo(map);
                });
                button.textContent = 'Ocultar Todos';
            }
            
            actualizarListaDispositivos();
        }
        
        // Funci√≥n para centrar la vista en todos los dispositivos
        function centrarEnTodos() {
            const ubicaciones = [];
            
            dispositivos.forEach((dispositivo) => {
                if (dispositivo.ultimaUbicacion && dispositivosVisibles.has(dispositivo.id)) {
                    ubicaciones.push([
                        parseFloat(dispositivo.ultimaUbicacion.lat),
                        parseFloat(dispositivo.ultimaUbicacion.lon)
                    ]);
                }
            });
            
            if (ubicaciones.length > 0) {
                if (ubicaciones.length === 1) {
                    map.setView(ubicaciones[0], 15);
                } else {
                    const group = new L.featureGroup(ubicaciones.map(pos => L.marker(pos)));
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }
        
        // Variable global para umbral de precisi√≥n
        let umbralPrecision = 100;
        
        // Configurar control de umbral de precisi√≥n
        function configurarControlPrecision() {
            const slider = document.getElementById('precisionThreshold');
            const valueDisplay = document.getElementById('precisionValue');
            
            if (slider && valueDisplay) {
                // Cargar umbral actual del servidor
                cargarUmbralPrecision();
                
                slider.addEventListener('input', function() {
                    umbralPrecision = parseInt(this.value);
                    valueDisplay.textContent = umbralPrecision + 'm';
                    
                    // Actualizar visualizaci√≥n de dispositivos seg√∫n nuevo umbral
                    actualizarVisualizacionPorPrecision();
                });
                
                // Enviar cambios al servidor cuando se suelte el slider
                slider.addEventListener('change', function() {
                    enviarUmbralAlServidor(umbralPrecision);
                });
            }
        }
        
        // Cargar umbral de precisi√≥n del servidor
        async function cargarUmbralPrecision() {
            try {
                const response = await fetch('/api/precision-threshold');
                const data = await response.json();
                
                if (data.threshold) {
                    umbralPrecision = data.threshold;
                    const slider = document.getElementById('precisionThreshold');
                    const valueDisplay = document.getElementById('precisionValue');
                    
                    if (slider && valueDisplay) {
                        slider.value = umbralPrecision;
                        slider.min = data.min || 10;
                        slider.max = data.max || 500;
                        valueDisplay.textContent = umbralPrecision + 'm';
                    }
                }
            } catch (error) {
                console.error('Error cargando umbral de precisi√≥n:', error);
            }
        }
        
        // Enviar umbral al servidor
        async function enviarUmbralAlServidor(threshold) {
            try {
                const response = await fetch('/api/precision-threshold', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ threshold })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Umbral de precisi√≥n actualizado:', data.message);
                } else {
                    console.error('Error actualizando umbral:', data.error);
                }
            } catch (error) {
                console.error('Error enviando umbral al servidor:', error);
            }
        }
        
        // Actualizar visualizaci√≥n basada en umbral de precisi√≥n
        function actualizarVisualizacionPorPrecision() {
            dispositivos.forEach((dispositivo, deviceId) => {
                if (dispositivo.ultimaUbicacion) {
                    const accuracy = parseFloat(dispositivo.ultimaUbicacion.accuracy) || 999;
                    const marker = marcadores.get(deviceId);
                    const circle = circulos.get(deviceId);
                    
                    if (marker && circle) {
                        // Cambiar opacidad basada en si cumple el umbral
                        const opacity = accuracy <= umbralPrecision ? 1.0 : 0.3;
                        marker.setOpacity(opacity);
                        circle.setStyle({ fillOpacity: opacity * 0.2, opacity: opacity * 0.5 });
                        
                        // Actualizar popup con nueva informaci√≥n
                        actualizarMarcadorDispositivo(dispositivo, dispositivo.ultimaUbicacion);
                    }
                }
            });
            
            // Actualizar lista de dispositivos
            actualizarListaDispositivos();
        }
        
        // Suprimir errores de extensiones del navegador
        window.addEventListener('error', function(event) {
            // Filtrar errores de content.js y otros scripts de extensiones
            if (event.filename && (event.filename.includes('content.js') || 
                                 event.filename.includes('extension') ||
                                 event.filename.includes('chrome-extension') ||
                                 event.filename.includes('moz-extension'))) {
                event.preventDefault();
                return true; // Prevenir que se muestre en consola
            }
        });
        
        // Suprimir errores no capturados de extensiones
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.stack && 
                (event.reason.stack.includes('content.js') ||
                 event.reason.stack.includes('extension'))) {
                event.preventDefault();
            }
        });

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando aplicaci√≥n GPS Android');
            
            // Inicializar mapa
            initMap();
            
            // Cargar datos iniciales (dispositivos y ubicaciones)
            cargarDatosIniciales();
            
            // Conectar WebSocket
            connectWebSocket();
            
            // Iniciar timer de sesi√≥n
            sessionTimer = setInterval(updateSessionTime, 1000);
            
            // Configurar event listeners para los botones
            document.getElementById('toggleAll').addEventListener('click', toggleTodosDispositivos);
            document.getElementById('centerAll').addEventListener('click', centrarEnTodos);
            
            // Configurar control de precisi√≥n
            configurarControlPrecision();
        });
    </script>
</body>
</html>